#!/usr/bin/env bash

## Copyright (C) 2020-2021 Aditya Shakya <adi1090x@gmail.com>
## Everyone is permitted to copy and distribute copies of this file under GNU-GPL3

## Files and Directories
DIR="$HOME/.config/bspwm/polybar"
SFILE="$DIR/system.ini"
RFILE="$DIR/.system"
MFILE="$DIR/.module"

## Get system variable values for various modules
get_values() {
    CARD=$(light -L | grep 'backlight' | head -n1 | cut -d'/' -f3)
    BATTERY=$(upower -i `upower -e | grep 'BAT'` | grep 'native-path' | cut -d':' -f2 | tr -d '[:blank:]')
    ADAPTER=$(upower -i `upower -e | grep 'AC'` | grep 'native-path' | cut -d':' -f2 | tr -d '[:blank:]')
    INTERFACE_WIRED=$(lshw -class network -json 2>/dev/null  | jq '. | map(select(.description == "Ethernet interface")) | .[0]?.logicalname' -r)
    INTERFACE_WIRELESS=$(lshw -class network -json 2>/dev/null  | jq '. | map(select(.description == "Wireless interface")) | .[0]?.logicalname' -r)
}

## Write values to `system` file
set_values() {
    if [[ ! -f "$SFILE" ]]; then
        cat > $SFILE <<EOF
[system]
adapter = AC
battery = BAT0
graphics_card = intel_backlight
network_interface_wired = eth0
network_interface_wireless = wlan0
EOF
    fi

    if [[ "$ADAPTER" ]]; then
        sed -i -e "s/adapter = .*/adapter = $ADAPTER/g"                         ${SFILE}
    fi
    if [[ "$BATTERY" ]]; then
        sed -i -e "s/battery = .*/battery = $BATTERY/g"                         ${SFILE}
    fi
    if [[ "$CARD" ]]; then
        sed -i -e "s/graphics_card = .*/graphics_card = $CARD/g"                ${SFILE}
    fi

    if [[ "$INTERFACE_WIRED" ]]; then
        sed -i -e "s/network_interface_wired = .*/network_interface_wired = $INTERFACE_WIRED/g"            ${SFILE}
    fi
    if [[ "$INTERFACE_WIRELESS" ]]; then
        sed -i -e "s/network_interface_wireless = .*/network_interface_wireless = $INTERFACE_WIRELESS/g"   ${SFILE}
    fi
}

## Launch Polybar with selected style
launch_bar() {
    CARD=$(light -L | grep 'backlight' | head -n1 | cut -d'/' -f3)

    if [[ ! -f "$MFILE" ]]; then
        if [[ -z "$CARD" ]]; then
            sed -i -e 's/backlight/bna/g' "$DIR"/config
        elif [[ "$CARD" != *"intel_"* ]]; then
            sed -i -e 's/backlight/brightness/g' "$DIR"/config
        fi

        touch "$MFILE"
    fi

    # export INTERFACE_WIRED=$(lshw -class network -json 2>/dev/null  | jq '. | map(select(.description == "Ethernet interface")) | .[0]?.logicalname' -r)
    # export INTERFACE_WIRELESS=$(lshw -class network -json 2>/dev/null  | jq '. | map(select(.description == "Wireless interface")) | .[0]?.logicalname' -r)

    # Terminate already running bar instances
    killall -q polybar

    # Wait until the processes have been shut down
    while pgrep -u $UID -x polybar >/dev/null; do sleep 1; done

    IFS_BAK=$IFS
    IFS=$'\n'
    for connected in $(xrandr -q | grep -w connected); do
        monitor=$(echo -n $connected | cut -d ' ' -f1)
        if [[ $connected == *primary* ]]; then
            bar=main
        else
            bar=sub
        fi
        MONITOR=${monitor} polybar -q ${bar} -c "$DIR"/config.ini &
    done
    IFS=$IFS_BAK
}

# Execute functions
if [[ ! -f "$RFILE" ]]; then
    get_values
    set_values
    touch ${RFILE}
fi
launch_bar
